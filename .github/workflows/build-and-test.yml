name: Build and Test (qmake, Qt6)

on:
  pull_request:
    branches: [ develop, main ]
  push:
    branches: [ develop, main ]
    tags: ['v*']

env:
  PRO_FILE: AUTO
  QT_VERSION: "6.6.0"

jobs:
  build-linux-qt6:
    name: Build & Test (Linux x86_64, Qt6)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      # --- OPTIMIZATION 1: Cache APT packages ---
      # This step will store the downloaded .deb files. On subsequent runs,
      # it will restore them, making the 'apt-get install' step nearly instant.
      - name: Cache APT packages
        id: cache-apt-packages
        uses: actions/cache@v4
        with:
          path: /var/cache/apt/archives
          key: ${{ runner.os }}-apt-${{ hashFiles('.github/packages.list') }}
          restore-keys: |
            ${{ runner.os }}-apt-

      # --- OPTIMIZATION 2: Consolidate ALL dependency installations ---
      # All apt-get update, add-repo, and install commands are now in one place.
      - name: Install System Dependencies (APT)
        run: |
          # Add NVIDIA VPI repository first
          sudo apt-get install -y --no-install-recommends software-properties-common gnupg
          sudo apt-key adv --fetch-key https://repo.download.nvidia.com/jetson/jetson-ota-public.asc
          sudo add-apt-repository 'deb https://repo.download.nvidia.com/jetson/x86_64/jammy r36.4 main'
          
          # Only run apt-get update if the cache was empty.
          if [[ ! "${{ steps.cache-apt-packages.outputs.cache-hit }}" == "true" ]]; then
            sudo apt-get update -y
          fi
          
          # Install all packages from our central list file.
          # The --no-install-recommends flag makes it faster and smaller.
          # The || true part prevents the workflow from failing if a single Qt package is not found.
          #sudo xargs -a .github/packages.list apt-get install -y --no-install-recommends || true
          grep -vE '^\s*#|^\s*$' .github/packages.list | sudo xargs apt-get install -y --no-install-
          
      - name: Install Qt (Qt6) with additional modules
        id: install-qt # Give this step an ID to reference its output
        uses: jurplel/install-qt-action@v3
        with:
          version: ${{ env.QT_VERSION }}
          host: linux
          target: desktop
          arch: gcc_64
          modules: 'qtserialbus qtserialport qtmultimedia'
          cache: true # This caches the Qt installer itself, which is also a big time saver.

      # --- OPTIMIZATION 3: Simplify qmake path finding ---
      # We use the direct output of the install-qt-action instead of a complex script.
      - name: Add Qt bin to PATH and show qmake
        shell: bash
        run: |
          echo "Found Qt path from action output: ${{ steps.install-qt.outputs.qt-path }}"
          echo "${{ steps.install-qt.outputs.qt-path }}/bin" >> $GITHUB_PATH
          echo "QT_ROOT_DIR=${{ steps.install-qt.outputs.qt-path }}" >> $GITHUB_ENV
          echo "CMAKE_PREFIX_PATH=${{ steps.install-qt.outputs.qt-path }}" >> $GITHUB_ENV
          qmake -v

      - name: Locate .pro file (auto) and configure
        shell: bash
        run: |
          cd $GITHUB_WORKSPACE
          if [ "${PRO_FILE}" = "AUTO" ]; then
            PRO_FILE_CAND=$(ls *.pro 2>/dev/null | head -n1 || true)
            if [ -z "$PRO_FILE_CAND" ]; then
              echo "No .pro file found at repo root." && exit 1
            fi
            PRO_FILE="$PRO_FILE_CAND"
          fi
          echo "Using PRO file: $PRO_FILE"

          mkdir -p build && cd build
          qmake "../${PRO_FILE}"

      - name: Build
        shell: bash
        run: |
          cd build
          make -j$(nproc)

      - name: Run unit/integration tests (if present)
        shell: bash
        run: |
          cd build
          if [ -x "./tests/tests" ]; then
            echo "Running tests..."
            ./tests/tests
          else
            echo "No tests/tests binary found â€” skipping test run."
          fi

      - name: Upload artifacts (on tag push only)
        if: startsWith(github.ref, 'refs/tags/')
        uses: actions/upload-artifact@v4
        with:
          name: myapp-binaries
          path: |
            build/src/*
            build/tests/*